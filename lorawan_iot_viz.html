<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LoRaWAN Network Visualization</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
    #map { height: 500px; width: 100%; }
    .controls { 
      margin: 20px;
      padding: 15px;
      background: white;
      border-radius: 5px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .sensor-list { 
      margin: 20px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    .sensor-item { 
      display: flex; 
      justify-content: space-between; 
      padding: 10px;
      border-bottom: 1px solid #eee;
    }
    #status {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      padding: 10px 20px;
      border: 1px solid #ccc;
      border-radius: 5px;
      z-index: 1000;
      display: none;
    }
    .config-section {
      margin: 20px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="config-section">
    <div class="controls">
      <h3>Device Configuration</h3>
      <label>Sensor Type:
        <select id="sensorType">
          <option value="temperature">Temperature</option>
          <option value="humidity">Humidity</option>
          <option value="airQuality">Air Quality</option>
          <option value="power">Power</option>
        </select>
      </label>
      
      <label>Environment:
        <select id="environment">
          <option value="urban">Urban</option>
          <option value="suburban">Suburban</option>
          <option value="rural">Rural</option>
          <option value="desert">Desert</option>
        </select>
      </label>
      
      <button id="addSensorBtn" style="margin-top: 10px;">Add Sensor</button>
      <button id="addGatewayBtn" style="margin-top: 5px;">Add Gateway</button>
    </div>

    <div class="sensor-list">
      <h3>Installed Sensors</h3>
      <div id="sensorList"></div>
    </div>
  </div>

  <div id="status"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // Map initialization
    const map = L.map('map').setView([33.975367, -117.328523], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    // State management
    let addingMode = null;
    const sensors = JSON.parse(localStorage.getItem('sensors')) || [];
    const gateways = JSON.parse(localStorage.getItem('gateways')) || [];
    
    // Configuration
    const sensorColors = {
      temperature: '#ff4444',
      humidity: '#44ff44',
      airQuality: '#4444ff',
      power: '#ffaa00'
    };

    const environmentRadii = {
      urban: 2000,
      suburban: 3500,
      rural: 5000,
      desert: 7000
    };

    // Load existing devices
    sensors.forEach(restoreSensor);
    gateways.forEach(restoreGateway);

    // Event handlers
    map.on('click', handleMapClick);
    document.getElementById('addSensorBtn').addEventListener('click', () => setAddingMode('sensor'));
    document.getElementById('addGatewayBtn').addEventListener('click', () => setAddingMode('gateway'));

    function setAddingMode(mode) {
      addingMode = mode;
      map.getContainer().style.cursor = 'crosshair';
      showStatus(`Click map to place ${mode}`);
    }

    function handleMapClick(e) {
      if (!addingMode) return;
      
      if (addingMode === 'sensor') {
        addSensor(e.latlng);
      } else {
        addGateway(e.latlng);
      }
      exitAddingMode();
    }

    function addSensor(latlng) {
      const type = document.getElementById('sensorType').value;
      const env = document.getElementById('environment').value;
      
      const sensor = {
        id: Date.now(),
        type,
        env,
        latlng,
        radius: environmentRadii[env],
        color: sensorColors[type]
      };

      createSensorMarker(sensor);
      sensors.push(sensor);
      updateSensorList();
      saveToStorage();
    }

    function createSensorMarker(sensor) {
      sensor.marker = L.marker(sensor.latlng, { draggable: true })
        .bindPopup(`${sensor.type} (${sensor.env})`)
        .addTo(map);
      
      sensor.circle = L.circle(sensor.latlng, {
        radius: sensor.radius,
        color: sensor.color,
        fillOpacity: 0.2
      }).addTo(map);

      sensor.marker.on('dragend', (e) => {
        const newPos = e.target.getLatLng();
        sensor.latlng = newPos;
        sensor.circle.setLatLng(newPos);
        saveToStorage();
      });
    }

    function addGateway(latlng) {
      const gateway = {
        id: Date.now(),
        latlng,
        marker: L.marker(latlng, { draggable: true })
          .bindPopup('Gateway')
          .addTo(map)
      };

      gateway.marker.on('dragend', (e) => {
        gateway.latlng = e.target.getLatLng();
        saveToStorage();
      });

      gateways.push(gateway);
      saveToStorage();
    }

    function restoreSensor(sensor) {
      sensor.latlng = L.latLng(sensor.latlng);
      createSensorMarker(sensor);
    }

    function restoreGateway(gateway) {
      gateway.latlng = L.latLng(gateway.latlng);
      gateway.marker = L.marker(gateway.latlng, { draggable: true })
        .bindPopup('Gateway')
        .addTo(map);
      
      gateway.marker.on('dragend', (e) => {
        gateway.latlng = e.target.getLatLng();
        saveToStorage();
      });
    }

    function updateSensorList() {
      const list = document.getElementById('sensorList');
      list.innerHTML = sensors.map((sensor, index) => `
        <div class="sensor-item">
          <span>${sensor.type} (${sensor.env})</span>
          <button onclick="removeSensor(${index})">Remove</button>
        </div>
      `).join('');
    }

    window.removeSensor = (index) => {
      const sensor = sensors[index];
      map.removeLayer(sensor.marker);
      map.removeLayer(sensor.circle);
      sensors.splice(index, 1);
      updateSensorList();
      saveToStorage();
    }

    function exitAddingMode() {
      addingMode = null;
      map.getContainer().style.cursor = '';
      document.getElementById('status').style.display = 'none';
    }

    function showStatus(message) {
      const status = document.getElementById('status');
      status.textContent = message;
      status.style.display = 'block';
      setTimeout(() => status.style.display = 'none', 2000);
    }

    function saveToStorage() {
      localStorage.setItem('sensors', JSON.stringify(sensors));
      localStorage.setItem('gateways', JSON.stringify(gateways));
    }

    updateSensorList();
  });
  </script>
</body>
</html>
